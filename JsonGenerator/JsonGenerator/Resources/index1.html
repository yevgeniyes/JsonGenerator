<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; Charset=UTF-8">
    <title>Diagram of total marks sum</title>
    <style>
        table {
            table-layout: fixed;
        }

        tr {
            font-size: 115%;
            font-weight: normal;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="students.js"></script>
    <script>
        //Check for the presence student with current "name" in "students" array
        function getStudentByName(students, name) {
            for (var i = 0; i < students.length; i++) {
                if (students[i].Name == name)
                    return students[i];
            }
            return null;
        }
        //Check for the presence subject with current "name" in "student.Subjects" array
        function getSubjectsByName(subjects, name) {
            for (var i = 0; i < subjects.length; i++) {
                if (subjects[i].Name == name)
                    return subjects[i];
            }
            return null;
        }
        //Calculation of the average mark
        function calcAvgMark(subject) {
            var sum = null;
            for (var i = 0; i < subject.Marks.length; i++) {
                sum = sum + subject.Marks[i];
            }
            if (sum != null)
                subject.Average = (sum / subject.Marks.length).toFixed(1);
        }
        //Calculation of the Total Score
        function calcTotalScore(students) {
            var score = null;
            for (var i = 0; i < students.Subjects.length; i++) {
                score = score + parseFloat(students.Subjects[i].Average);
            }
            if (score != null)
                students.TotalScore = score.toFixed(1);
        }
        //Creating data model
        function createModel() {
            var students = [];
            for (var i = 0; i < data.length; i++) {
                var line = data[i];
                var student = getStudentByName(students, line.Name);
                if (student == null) {
                    student = { Name: line.Name, Subjects: [], TotalScore: null };
                    students.push(student);
                }
                var subject = getSubjectsByName(student.Subjects, line.Subject);
                if (subject == null) {
                    subject = { Name: line.Subject, Marks: [], Average: null };
                    student.Subjects.push(subject);
                }
                subject.Marks.push(line.Mark);
            }
            for (var i = 0; i < students.length; i++) {
                var studentI = students[i];
                for (var j = 0; j < studentI.Subjects.length; j++) {
                    calcAvgMark(studentI.Subjects[j]);
                }
                calcTotalScore(studentI);
            }
            //Sorting objects in data model by alphabet
            students.sort(function (a, b) {
                if (a.Name > b.Name) {
                    return 1;
                }
                if (a.Name < b.Name) {
                    return -1;
                }
                return 0;
            });

            return students;
        }
        //Get subjects list
        function getSubjectsList(students) {
            var subjectsList = [];
            for (var i = 0; i < students.length; i++) {
                if (subjectsList.length == 0) {
                    subjectsList.push(students[i].Subjects[i].Name);
                    continue;
                }
                var studentI = students[i];
                for (var j = 0; j < studentI.Subjects.length; j++) {
                    var subjectExists = false;
                    var subjectJ = studentI.Subjects[j];
                    for (var k = 0; k < subjectsList.length; k++) {
                        if (subjectJ.Name == subjectsList[k]) {
                            subjectExists = true;
                            continue;
                        }
                    }
                    if (!subjectExists) subjectsList.push(subjectJ.Name);
                }
            }
            return subjectsList;
        }

        //Creating table based on data model
        function createTable(students) {
            //Subjects list used to calculate width constant
            var subjectsList = getSubjectsList(students);
            var colors = ["#c70000", "#d41111", "#f51b22", "#f27d66", "#edf761", "#f2d166", "#afdf49", "#afc249", "#3dbd45", "#3dab45"];
            var table = document.createElement("TABLE");
            table.border = 0;
            table.width = 650;
            document.body.appendChild(table);

            //Table Rows creating
            for (var i = 0; i < students.length; i++) {
                var newRow = table.insertRow(i);
                var newCell = newRow.insertCell(0);
                newCell.style['background'] = '#c2c2c2';
                newCell.style['font-weight'] = '900';
                newCell.style['text-align'] = 'center';
                newCell.innerText = students[i].Name;
                //Cell and div creating
                var newCell = newRow.insertCell(-1);
                newCell.width = "82%";
                var div = document.createElement('div');
                var score = students[i].TotalScore;
                var studentScore = parseFloat(score);
                var constant = (studentScore / subjectsList.length);
                //Selecting score line color based on width constant
                var lineColor;
                if (constant <= 2.2) lineColor = colors[0];
                if (constant > 2.2 && constant <= 2.5) lineColor = colors[1];
                if (constant > 2.5 && constant <= 2.7) lineColor = colors[2];
                if (constant > 2.7 && constant <= 3) lineColor = colors[3];
                if (constant > 3 && constant <= 3.2) lineColor = colors[4];
                if (constant > 3.2 && constant <= 3.5) lineColor = colors[5];
                if (constant > 3.5 && constant <= 3.8) lineColor = colors[6];
                if (constant > 3.8 && constant <= 4) lineColor = colors[7];
                if (constant > 4 && constant <= 4.5) lineColor = colors[8];
                if (constant > 4.5) lineColor = colors[9];
                //Width calculation. Applying width and color
                var scoreLineWidth = studentScore * constant;
                var width = scoreLineWidth + "px";
                var widthForScoreShow = (scoreLineWidth + 5) + "px";
                div.style.width = width;
                div.style.height = "18px";
                div.style.background = lineColor;
                div.style['vertical-align'] = 'top';
                div.style['text-indent'] = widthForScoreShow;
                //Remove .0
                if (score.charAt(score.length - 1) == "0") {
                    score = score.substring(0, score.length - 2);
                }
                div.innerText = score;
                newCell.appendChild(div);
            }
        }
        //Main function
        $(document).ready(function () {
            var model = createModel();
            createTable(model);
        });
    </script>
</head>
<body>
    <form action="index.html">
        <p>Click button to view: <button type="submit">Table with average marks</button></p>
    </form>
    <h1>Diagram of total marks sum</h1>
</body>
</html>
