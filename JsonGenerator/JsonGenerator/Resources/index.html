<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; Charset=UTF-8">
    <style>
		table {
			table-layout: fixed;
		}
        tr {
            font-size: 115%;
            font-weight: normal;
            text-align: center;
        }
        td {
            background: #c2c2c2;
        }
		.good {
			background: #3dd445;
		}
		.normal {
			background: #afeb49;
		}
		.low {
			background: #edd861;
		}
		.bad {
			background: #f27d66;
		}
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="students.js"></script>
    <script>
        //Check for the presence student with current "name" in "students" array
        function getStudentByName(students, name) {
            for (var i = 0; i < students.length; i++) {
                if (students[i].Name == name)
                    return students[i];
            }
            return null;
        }
        //Check for the presence subject with current "name" in "student.Subjects" array
        function getSubjectsByName(subjects, name) {
            for (var i = 0; i < subjects.length; i++) {
                if (subjects[i].Name == name)
                    return subjects[i];
            }
            return null;
        }
        //Calculation of the average mark (integer)
        function calcAvgMark(subject) {
            var sum = null;
            for (var i = 0; i < subject.Marks.length; i++) {
                sum = sum + subject.Marks[i];
            }
            if (sum != null)
                subject.Average = (sum / subject.Marks.length).toFixed(1);
        }
        //Creating data model
        function createModel() {
            var students = [];
            for (var i = 0; i < data.length; i++) {
                var line = data[i];
                var student = getStudentByName(students, line.Name);
                if (student == null) {
                    student = { Name: line.Name, Subjects: [] };
                    students.push(student);
                }
                var subject = getSubjectsByName(student.Subjects, line.Subject);
                if (subject == null) {
                    subject = { Name: line.Subject, Marks: [], Average: null };
                    student.Subjects.push(subject);
                }
                subject.Marks.push(line.Mark);
            }
            for (var i = 0; i < students.length; i++) {
                var studentI = students[i];
                for (var j = 0; j < studentI.Subjects.length; j++) {
                    calcAvgMark(studentI.Subjects[j]);
                }
            }
            //Sorting objects in data model by alphabet
            students.sort(function (a, b) {
                if (a.Name > b.Name) {
                    return 1;
                }
                if (a.Name < b.Name) {
                    return -1;
                }
                return 0;
            });
            return students;
        }
        //Get subjects list
        function getSubjectsList(students) {
            var subjectsList = [];
            for (var i = 0; i < students.length; i++) {
                if (subjectsList.length == 0) {
                    subjectsList.push(students[i].Subjects[i].Name);
                    continue;
                }
                var studentI = students[i];
                for (var j = 0; j < studentI.Subjects.length; j++) {
                    var subjectExists = false;
                    var subjectJ = studentI.Subjects[j];
                    for (var k = 0; k < subjectsList.length; k++) {
                        if (subjectJ.Name == subjectsList[k]) {
                            subjectExists = true;
                            continue;
                        }
                    }
                    if (!subjectExists) subjectsList.push(subjectJ.Name);
                }
            }
            return subjectsList;
        }

        //Creating table based on data model
        function createTable(students) {
            //Subjects list used to build header and make equal column width
            var subjectsList = getSubjectsList(students);
            subjectsList.sort();

            var table = document.createElement("TABLE");
            table.border = 0;
            table.width = subjectsList.length * 125;
            document.body.appendChild(table);
            //Table Header creating
            var newRow = table.insertRow(0);
            var newCell = newRow.insertCell(0);
            newCell.style['background'] = 'transparent';

            for (var i = 0; i < subjectsList.length; i++) {
                var newCell = newRow.insertCell(-1);
                newCell.innerText = subjectsList[i];
                newCell.style['font-weight'] = '900';
            }
            //Table Rows creating
            for (var i = 0; i < students.length; i++) {
                var newRow = table.insertRow(i + 1);
                var newCell = newRow.insertCell(0);
                newCell.innerHTML = students[i].Name;
                newCell.style['font-weight'] = '900';

                for (var j = 0; j < subjectsList.length; j++) {
                    var newCell = newRow.insertCell(-1);
                    var subjectFromList = subjectsList[j];

                    for (var k = 0; k < students[i].Subjects.length; k++) {
                        var studentK = students[i].Subjects[k]
                        if (studentK.Name == subjectFromList && studentK.Average != null) {
                            newCell.style['font-size'] = '120%';
                            newCell.innerHTML = studentK.Average;

                            switch (studentK.Average.charAt(0)) {
                                case "5": newCell.setAttribute("class", "good");
                                    break;
                                case "4": newCell.setAttribute("class", "normal");
                                    break;
                                case "3": newCell.setAttribute("class", "low");
                                    break;
                                case "2": newCell.setAttribute("class", "bad");
                                    break;
                            }
                        }
                    }
                }
            }
        }
        //Main function
        $(document).ready(function () {
            var model = createModel();
            createTable(model);
        });
    </script>
</head>
<body>
</body>
</html>
